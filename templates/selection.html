<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/selection.css') }}">
    <title>Seleção de Candidatos</title>
</head>
<body>
    <div class="container">
        <header>
            <h1>Seleção de Candidatos</h1>
        </header>

        <div class="sidebar">
            <ul>
                <li><a href="/mainpage">Página Principal</a></li>
                <li><a href="/selectionpage">Seleção de Candidatos</a></li>
                <li><a href="/consulta">Página de Dados</a></li>
            </ul>
            <button class="toggle-button">Bolsas</button>
            <ul class="bolsas-menu" style="display:none;">
                <li><a href="/Bolsas/SaoMiguel">Bolsa de Ilha São Miguel</a></li>
                <li><a href="/Bolsas/Terceira">Bolsa de Ilha Terceira</a></li>
                <li><a href="/Bolsas/SantaMaria">Bolsa de Ilha Santa Maria</a></li>
                <li><a href="/Bolsas/Faial">Bolsa de Ilha Faial</a></li>
                <li><a href="/Bolsas/Pico">Bolsa de Ilha Pico</a></li>
                <li><a href="/Bolsas/SaoJorge">Bolsa de Ilha São Jorge</a></li>
                <li><a href="/Bolsas/Graciosa">Bolsa de Ilha Graciosa</a></li>
                <li><a href="/Bolsas/Flores">Bolsa de Ilha Flores</a></li>
                <li><a href="/Bolsas/Corvo">Bolsa de Ilha Corvo</a></li>
            </ul>
            <ul>
                <li><a href="/minhaconta">Minha conta</a></li>
                <li><a href="/add_user">Adicionar candidato</a></li>
                <li><a href="/logout">Terminar sessão</a></li>
            </ul>
        </div>

        <div class="content">
            <h2>Formulário para Seleção</h2>
            <form action="/submit_selection" method="POST" class="form-horizontal">
                <div class="form-group">
                    <label for="vaga_deficiencia">A vaga é exclusiva a deficiência?</label>
                    <select id="vaga_deficiencia" name="vaga_deficiencia" required onchange="handleDeficienciaChange()">
                        <option value="">-</option>
                        <option value="sim">Sim</option>
                        <option value="nao">Não</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="numero">Número de Candidatos Necessários:</label>
                    <input type="number" id="numero" name="numero" placeholder="Insira o número de candidatos" required oninput="calculateVagas()">
                </div>

                <div class="form-group">
                    <label for="ilha">Ilha (Bolsa):</label>
                    <select id="ilha" name="ilha" required>
                        <option value="">Selecione a bolsa/ilha</option>
                        {% for bolsa in bolsas %}
                            <option value="{{ bolsa[0] }}">{{ bolsa[1] }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="form-group">
                    <label for="escola">Escolas:</label>
                    <select id="escola" name="escola" required>
                        <option value="">Selecione a escola</option>
                    </select>
                </div>

                <!-- Hidden inputs for vagas -->
                <input type="hidden" id="normal" name="normal" value="0">
                <input type="hidden" id="deficiencia" name="deficiencia" value="0">

                <div class="form-group">
                    <label for="contrato">Tipo de Contrato:</label>
                    <select id="contrato" name="contrato_id" required>
                        <option value="">Selecione o tipo de contrato</option>
                        <option value="1">CTFP por tempo indeterminado</option>
                        <option value="2">CTFP a termo resolutivo</option>
                        <option value="3">CTFP por tempo indeterminado e CTFP a termo resolutivo</option>
                    </select>
                </div>

                <button type="button" id="addSchoolBtn">Adicionar Escola</button>

                <div class="selected-schools">
                    <h3>Escolas Selecionadas</h3>
                    <table id="selectedSchoolsTable">
                        <thead>
                            <tr>
                                <th>Nome da Escola</th>
                                <th>Vagas Normais</th>
                                <th>Vagas para Deficientes</th>
                                <th>Tipo de Contrato</th>
                                <th>Vaga exclusiva a deficiência</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Selected schools will be added here -->
                        </tbody>
                    </table>
                </div>

                <!-- Hidden inputs for selected schools and their vagas -->
                <input type="hidden" name="escolas[]" id="escolas">

                <div class="form-group">
                    <button type="submit">Submeter</button>
                </div>
            </form>
        </div>

        <footer>
            <p>Footer content here.</p>
        </footer>
    </div>

    <script>
        document.querySelector('.toggle-button').addEventListener('click', function() {
            const bolsasMenu = document.querySelector('.bolsas-menu');
            bolsasMenu.style.display = bolsasMenu.style.display === 'block' ? 'none' : 'block';
        });

        document.getElementById('ilha').addEventListener('change', function() {
            const bolsaId = this.value;
            const escolaSelect = document.getElementById('escola');
    
            escolaSelect.innerHTML = '<option value="">Selecione a escola</option>';  // Clear previous options
    
            if (bolsaId) {
                fetch(`/get_escolas/${bolsaId}`)
                    .then(response => response.json())
                    .then(data => {
                        data.escolas.forEach(escola => {
                            const option = document.createElement('option');
                            option.value = escola; // Set the value to the school name directly
                            option.textContent = escola; // Set the text to the school name
                            escolaSelect.appendChild(option);
                        });
                    })
                    .catch(error => {
                        console.error('Error fetching escolas:', error);
                    });
            }
        });

        document.getElementById('addSchoolBtn').addEventListener('click', function() {
            const escolaSelect = document.getElementById('escola');
            const selectedValue = escolaSelect.value;
            const selectedText = escolaSelect.options[escolaSelect.selectedIndex].text;
            const vagasInput = document.getElementById('normal').value; // Get normal vagas
            const deficienciaInput = document.getElementById('deficiencia').value; // Get deficiency vagas
            const contratoSelect = document.getElementById('contrato');
            const selectedContrato = contratoSelect.value; // Get contract type
            const vagaDeficienciaSelect = document.getElementById('vaga_deficiencia').value; // Get selected deficiency option

            if (selectedValue && vagasInput && deficienciaInput && contratoSelect.value) {
                // Add selected school to the table
                const tableBody = document.getElementById('selectedSchoolsTable').querySelector('tbody');
                const row = document.createElement('tr');

                row.innerHTML = `
                    <td>${selectedText}</td>
                    <td>${vagasInput}</td>
                    <td>${deficienciaInput}</td>
                    <td>${contratoSelect.options[contratoSelect.selectedIndex].text}</td>
                    <td>${vagaDeficienciaSelect}</td>
                    <td><button class="removeSchoolBtn">Remover</button></td>
                `;
                tableBody.appendChild(row);

                // Add hidden input for the selected school
                const escolasInput = document.getElementById('escolas');
                escolasInput.value += `${selectedText},`; // Append school name to the hidden input

                // Clear the selections
                escolaSelect.value = '';
                document.getElementById('numero').value = ''; // Clear the number of candidates
                document.getElementById('normal').value = '0'; // Reset normal vagas
                document.getElementById('deficiencia').value = '0'; // Reset deficiency vagas
                contratoSelect.value = '';
                document.getElementById('vaga_deficiencia').value = ''; // Reset the deficiency selection

                // Add event listener to remove button
                row.querySelector('.removeSchoolBtn').addEventListener('click', function() {
                    tableBody.removeChild(row);
                });
            } else {
                alert('Por favor, preencha todos os campos antes de adicionar uma escola.');
            }
        });

        function handleDeficienciaChange() {
            const vagaDeficienciaSelect = document.getElementById('vaga_deficiencia').value;
            const normalVagas = document.getElementById('numero').value;

            if (vagaDeficienciaSelect === "sim") {
                // Set the deficiency vagas to be the same as normal vagas
                document.getElementById('deficiencia').value = normalVagas;
            } else {
                // Reset deficiency vagas if not exclusive
                document.getElementById('deficiencia').value = (normalVagas > 3) ? Math.ceil(normalVagas * 0.2) : 0;
            }
        }

        function calculateVagas() {
            const number = document.getElementById('numero').value;
            document.getElementById('normal').value = number;
            // Calculate deficiency vagas based on the number of normal vacancies
            document.getElementById('deficiencia').value = (number > 3) ? Math.ceil(number * 0.2) : 0;
        }
    </script>
</body>
</html>